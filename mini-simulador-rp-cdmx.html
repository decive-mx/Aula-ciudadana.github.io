<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mini‑Simulador de Asignación de Diputaciones por RP – CDMX</title>
<style>
  :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#a78bfa; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; }
  html,body{background:var(--bg);color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, sans-serif;margin:0;padding:0}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:1.6rem;margin:0 0 12px}
  .card{background:var(--card);border-radius:14px;padding:16px 16px 12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .col{flex:1 1 240px}
  label{font-weight:600;font-size:.92rem}
  input,button,select{background:#0b1220;color:var(--text);border:1px solid #26314d;border-radius:10px;padding:10px 12px}
  input:focus,select:focus,button:focus{outline:2px solid var(--accent)}
  button{cursor:pointer}
  .tiny{font-size:.82rem;color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px;border-bottom:1px solid #1f2937;text-align:right}
  th:first-child, td:first-child{text-align:left}
  thead th{position:sticky;top:0;background:#0b1220}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.78rem}
  .ok{background:rgba(16,185,129,.15);color:var(--ok)}
  .bad{background:rgba(239,68,68,.15);color:var(--bad)}
  .muted{color:var(--muted)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  details{margin-top:6px}
  .footer{margin-top:10px;font-size:.85rem;color:var(--muted)}
  .note{font-size:.88rem;color:var(--muted);margin-top:8px}
  .tag{background:#1f2937;border-radius:8px;padding:3px 8px;margin-left:6px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Mini‑Simulador de Asignación de Diputaciones por Representación Proporcional (CDMX)</h1>
    <div class="card">
      <div class="row">
        <div class="col">
          <label>Votación válida emitida total (VVE)</label>
          <input id="vve" type="number" min="0" step="1" placeholder="Ej. 2,500,000" />
          <div class="tiny">Si lo dejas vacío, se usará la suma de votos de los partidos capturados.</div>
        </div>
        <div class="col">
          <label>Curules RP a asignar</label>
          <input id="rpSeats" type="number" value="33" min="1" max="100" />
        </div>
        <div class="col">
          <label>Curules totales del Congreso</label>
          <input id="totalSeats" type="number" value="66" min="1" max="200" />
        </div>
        <div class="col">
          <label>Umbral (mínimo legal)</label>
          <div class="row">
            <input id="thresholdPct" type="number" value="3" min="0" max="10" step="0.1" style="max-width:120px" />
            <span class="tiny" style="align-self:center">%</span>
          </div>
        </div>
      </div>

      <details>
        <summary>Avanzado (límite de sobrerrepresentación y techo por partido)</summary>
        <div class="row">
          <div class="col">
            <label>Límite de sobrerrepresentación</label>
            <div class="row">
              <input id="overCapPct" type="number" value="8" min="0" max="20" step="0.1" style="max-width:120px" />
              <span class="tiny" style="align-self:center">puntos porcentuales por arriba del % de votación local emitida</span>
            </div>
          </div>
          <div class="col">
            <label>Techo de curules por partido (ambos principios)</label>
            <input id="partyCeiling" type="number" value="33" min="1" max="200" />
          </div>
        </div>
        <div class="note">Este simulador aplica el tope de +8 pts y el techo de curules deduciendo <b>curules RP</b> cuando sea necesario y redistribuyéndolos según <i>cociente de distribución</i> y <i>resto mayor</i>. No implementa ajustes de paridad ni reglas especiales de coaliciones. </div>
      </details>

      <h3 style="margin-top:16px">Partidos</h3>
      <div class="tiny">Captura <b>votos</b> (no porcentajes) y <b>curules de mayoría relativa</b> que ya obtuvieron.</div>
      <table id="tbl">
        <thead>
          <tr>
            <th>Partido</th>
            <th>Votos</th>
            <th>MR (curules)</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
      <div class="row" style="margin-top:8px">
        <button id="add">+ Agregar partido</button>
        <button id="example">Cargar ejemplo</button>
        <span class="tag">Tip: puedes pegar números con comas.</span>
      </div>

      <div class="row" style="margin-top:14px">
        <button id="run" style="font-weight:700;border:1px solid #6d28d9">Calcular asignación</button>
        <button id="clear">Limpiar</button>
      </div>

      <div id="out" style="margin-top:16px"></div>
      <div class="footer">Simplificado para fines educativos. Verifica siempre con la normatividad vigente del IECM.</div>
    </div>
  </div>

<script>
const $ = (q)=>document.querySelector(q);
const tbody = $('#tbody');

function addRow(name='', votes='', mr=''){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td style="text-align:left"><input class="pname" placeholder="Partido" value="${name}"></td>
    <td><input class="pvotes" type="text" inputmode="numeric" value="${votes}"></td>
    <td><input class="pmr" type="number" min="0" step="1" value="${mr}"></td>
    <td><button class="del">✕</button></td>`;
  tr.querySelector('.del').onclick = ()=> tr.remove();
  tbody.appendChild(tr);
}

$('#add').onclick = ()=> addRow();
$('#clear').onclick = ()=> { tbody.innerHTML=''; $('#out').innerHTML=''; };
$('#example').onclick = ()=> {
  tbody.innerHTML='';
  addRow('Partido A', '900,000', 24);
  addRow('Partido B', '620,000', 6);
  addRow('Partido C', '420,000', 2);
  addRow('Partido D', '220,000', 1);
  addRow('Partido E', '70,000', 0); // <3%
  $('#vve').value = '2,300,000';
};

// helpers
function num(x){ if(typeof x==='number') return x; return parseFloat(String(x).replace(/[,\s]/g,''))||0; }
function fmt(n){ return n.toLocaleString('es-MX'); }
function pct(n){ return (100*n).toFixed(2)+'%'; }

$('#run').onclick = ()=>{
  const rpSeats = Math.max(1, num($('#rpSeats').value)||33);
  const totalSeats = Math.max(rpSeats, num($('#totalSeats').value)||66);
  const threshold = (num($('#thresholdPct').value)||3)/100;
  const overCap = (num($('#overCapPct').value)||8)/100;
  const partyCeiling = Math.min(totalSeats, num($('#partyCeiling').value)||33);

  const rows = [...tbody.querySelectorAll('tr')].map(tr=>({
    name: tr.querySelector('.pname').value.trim()||'—',
    votes: num(tr.querySelector('.pvotes').value),
    mr: Math.max(0, Math.floor(num(tr.querySelector('.pmr').value)||0))
  })).filter(r=>r.votes>0 || r.mr>0);

  if(rows.length===0){ $('#out').innerHTML = '<div class="note">Agrega al menos un partido.</div>'; return; }

  // Total VVE base
  let VVE = num($('#vve').value) || rows.reduce((s,r)=>s+r.votes,0);
  if(VVE<=0){ VVE = rows.reduce((s,r)=>s+r.votes,0); }

  // Filtrar por umbral 3% de VVE
  const eligible = rows.filter(r=> r.votes >= threshold*VVE );
  const excluded = rows.filter(r=> r.votes < threshold*VVE );

  const VLE = eligible.reduce((s,r)=>s+r.votes,0); // votación local emitida
  const CN = VLE / rpSeats; // cociente natural

  // Asignación inicial por cociente natural + resto mayor
  eligible.forEach(p=>{
    p.pr = Math.floor(p.votes / CN);
    p.rem = p.votes - p.pr*CN;
  });
  let assigned = eligible.reduce((s,p)=>s+p.pr,0);
  // Resto mayor
  if(assigned < rpSeats){
    const need = rpSeats - assigned;
    eligible.sort((a,b)=> b.rem - a.rem );
    for(let i=0;i<need;i++) eligible[i%eligible.length].pr++;
    assigned = rpSeats;
  }

  // Chequeo y corrección por topes (8 pp y techo de curules)
  // Funciones auxiliares
  const maxAllowedSeats = (p)=>{
    const voteShareLocal = p.votes / VLE;
    const capShare = voteShareLocal + overCap;
    const capSeats = Math.floor(capShare * totalSeats + 1e-9);
    return Math.min(partyCeiling, capSeats);
  };

  const state = ()=>{
    const all = eligible.concat(excluded);
    all.forEach(p=>{ if(p.pr==null) p.pr=0; });
    all.forEach(p=>{ p.total = (p.mr||0) + (p.pr||0); });
    return all;
  };

  let changed = true; let guard=0;
  while(changed && guard<20){
    guard++;
    changed = false;
    const allNow = state();

    // ¿Quién rebasa?
    const offenders = eligible.filter(p=>{
      const maxS = maxAllowedSeats(p);
      return p.total > maxS || p.total > partyCeiling;
    });

    if(offenders.length===0) break;

    // ¿Cuántas RP hay que deducir y redistribuir?
    let seatsToRedistribute = 0;
    const offendersSet = new Set();
    offenders.forEach(p=>{
      offendersSet.add(p.name);
      const maxS = Math.min(maxAllowedSeats(p), partyCeiling);
      const need = Math.max(0, p.total - maxS);
      const take = Math.min(need, p.pr||0); // sólo podemos quitar RP
      if(take>0){ p.pr -= take; seatsToRedistribute += take; changed = true; }
    });

    if(seatsToRedistribute<=0){ break; }

    // Votación ajustada: excluir votos de los partidos a los que se les dedujeron curules
    const adjustedEligible = eligible.filter(p=> !offendersSet.has(p.name) );
    const VAdj = adjustedEligible.reduce((s,p)=>s+p.votes,0);
    if(VAdj<=0){ break; }
    const CDist = VAdj / seatsToRedistribute; // cociente de distribución

    // Distribuir por cociente de distribución + resto mayor
    adjustedEligible.forEach(p=>{ p.tmpAdd = Math.floor(p.votes / CDist); p.tmpRem = p.votes - p.tmpAdd*CDist; });
    let addAssigned = adjustedEligible.reduce((s,p)=>s+p.tmpAdd,0);
    let left = seatsToRedistribute - addAssigned;
    adjustedEligible.sort((a,b)=> b.tmpRem - a.tmpRem );
    for(let i=0;i<left;i++) adjustedEligible[i%adjustedEligible.length].tmpAdd++;
    // Aplicar
    adjustedEligible.forEach(p=>{ p.pr += p.tmpAdd; delete p.tmpAdd; delete p.tmpRem; });
  }

  // Resultado final
  const all = state();
  // Construir salida
  const VVEfmt = fmt(VVE), VLEfmt = fmt(VLE), CNfmt = fmt(Math.round(CN));

  let html = '';
  html += `<div class="grid2">
    <div><b>VVE</b>: ${VVEfmt} <span class="muted">(votación válida emitida)</span></div>
    <div><b>VLE</b>: ${VLEfmt} <span class="muted">(local emitida tras umbral)</span></div>
    <div><b>Curules RP</b>: ${rpSeats}</div>
    <div><b>Cociente natural</b>: ${fmt(CN.toFixed(2))}</div>
  </div>`;

  // Tabla
  html += `<table><thead><tr>
    <th>Partido</th>
    <th>Votos</th>
    <th>% VVE</th>
    <th>% VLE</th>
    <th>MR</th>
    <th>RP</th>
    <th>Total</th>
    <th>% curules</th>
    <th>Over/Under</th>
  </tr></thead><tbody>`;

  // order by total desc
  all.sort((a,b)=> (b.total||0)-(a.total||0) );

  all.forEach(p=>{
    const vveShare = VVE>0? p.votes/VVE : 0;
    const vleShare = VLE>0? p.votes/VLE : 0;
    const seatShare = totalSeats>0? (p.total||0)/totalSeats : 0;
    const diff = seatShare - vleShare;
    const pill = diff>overCap ? `<span class="pill bad">+${((diff)*100).toFixed(2)} pp</span>` : `<span class="pill ok">${((diff)*100).toFixed(2)} pp</span>`;
    html += `<tr>
      <td style="text-align:left">${p.name}${ (p.votes < threshold*VVE) ? ' <span class="pill"><small>sin derecho (<' + (threshold*100).toFixed(1) + '%)</small></span>' : ''}</td>
      <td>${fmt(p.votes)}</td>
      <td>${pct(vveShare)}</td>
      <td>${pct(vleShare)}</td>
      <td>${fmt(p.mr||0)}</td>
      <td>${fmt(p.pr||0)}</td>
      <td>${fmt(p.total||0)}</td>
      <td>${pct(seatShare)}</td>
      <td>${pill}</td>
    </tr>`
  });
  html += `</tbody></table>`;

  // Notas de advertencia
  const offendersAfter = eligible.filter(p=> {
    const maxS = Math.min(maxAllowedSeats(p), partyCeiling);
    return p.total > maxS; });
  if(offendersAfter.length>0){
    html += `<div class="note">Aviso: al menos un partido rebasa límites legales exclusivamente con sus curules de MR (no es posible reducirlas). El simulador agota la deducción de RP y muestra el excedente resultante.</div>`;
  }

  $('#out').innerHTML = html;
};

// Start with two rows
addRow('Partido A', '', '');
addRow('Partido B', '', '');
</script>
</body>
</html>